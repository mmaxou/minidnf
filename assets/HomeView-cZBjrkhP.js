import{P as p,_ as Y,c as x,w as t,r as _,f as Z,g as $,h as ee,i as ae,u as le,a as n,o as b,b as l,d as s,t as y,e as B,j as G,k as V,F as H,l as te,n as re,m as oe,p as ne}from"./index-DYD77XOx.js";const S=p.Object.extend("Character"),se=async()=>{try{const d=p.User.current();if(!d)return{success:!1,error:"用户未登录"};const e=new p.Query(S);return e.equalTo("user",d),e.descending("updatedAt"),{success:!0,characters:(await e.find()).map(i=>({id:i.id,name:i.get("name"),job:i.get("job"),level:i.get("level"),lastPlayTime:i.get("lastPlayTime").toLocaleString()}))}}catch(d){return console.error("获取角色列表失败:",d),{success:!1,error:d.message||"获取角色列表失败"}}},O=async d=>{try{const e=new p.Query(S);return e.equalTo("name",d),await e.count()>0}catch(e){throw console.error("检查角色名称失败:",e),e}},ie=async d=>{try{const e=p.User.current();if(!e)return{success:!1,error:"用户未登录"};if(await O(d.name))return{success:!1,error:"角色名称已存在，请使用其他名称"};const a=new S;a.set("name",d.name),a.set("job",d.job),a.set("level",d.level||1),a.set("lastPlayTime",new Date),a.set("user",e);const i=await a.save();return{success:!0,character:{id:i.id,name:i.get("name"),job:i.get("job"),level:i.get("level"),lastPlayTime:i.get("lastPlayTime").toLocaleString()}}}catch(e){return console.error("创建角色失败:",e),{success:!1,error:e.message||"创建角色失败"}}},ce=async d=>{try{const e=p.User.current();if(!e)return{success:!1,error:"用户未登录"};const a=await new p.Query(S).get(d);return a.get("user").id!==e.id?{success:!1,error:"无权删除此角色"}:(await a.destroy(),{success:!0})}catch(e){return console.error("删除角色失败:",e),{success:!1,error:e.message||"删除角色失败"}}},de=async d=>{try{const f=await new p.Query(S).get(d);return f.set("lastPlayTime",new Date),await f.save(),{success:!0,lastPlayTime:f.get("lastPlayTime").toLocaleString()}}catch(e){return console.error("更新游戏时间失败:",e),{success:!1,error:e.message||"更新游戏时间失败"}}},U={getUserCharacters:se,checkCharacterNameExists:O,createCharacter:ie,deleteCharacter:ce,updateLastPlayTime:de},ue={name:"HomeView",setup(){const d=ae("authService"),e=le(),f=_(null),a=_(!0),i=_(""),M=_(null),C=_([]),w=[{value:"鬼剑士",text:"鬼剑士",icon:"mdi-sword"},{value:"格斗家",text:"格斗家",icon:"mdi-boxing-glove"},{value:"神枪手",text:"神枪手",icon:"mdi-pistol"},{value:"魔法师",text:"魔法师",icon:"mdi-magic-staff"},{value:"圣职者",text:"圣职者",icon:"mdi-cross"},{value:"刺客",text:"刺客",icon:"mdi-knife"}],c=_(null),m=_({name:"",job:null}),v=_(!0),I=[r=>!!r||"角色名称不能为空",r=>r&&r.length>=2&&r.length<=12||"角色名称长度必须在2-12个字符之间"],L=[r=>!!r||"必须选择职业"],k=_(!1),P=_(!1),g=_(!1);Z(k,r=>{r||(m.value={name:"",job:null},i.value="",M.value&&M.value.resetValidation())});const h=async()=>{a.value=!0,i.value="";try{const r=await U.getUserCharacters();r.success?C.value=r.characters:i.value=r.error||"无法加载角色列表"}catch(r){console.error("加载角色失败:",r),i.value="加载角色时出错"}finally{a.value=!1}},z=r=>({鬼剑士:"red-lighten-4",格斗家:"amber-lighten-4",神枪手:"blue-lighten-4",魔法师:"purple-lighten-4",圣职者:"green-lighten-4",刺客:"grey-lighten-3"})[r]||"grey-lighten-3",E=r=>{const u=w.find(j=>j.value===r);return u?u.icon:"mdi-account"},q=$(()=>c.value!==null),N=async()=>{if(!(!v.value||!m.value.job)){g.value=!0,i.value="";try{const r=typeof m.value.job=="object"?m.value.job.value:m.value.job,u=await U.createCharacter({name:m.value.name,job:r,level:1});u.success?(C.value.unshift(u.character),m.value={name:"",job:null},k.value=!1):i.value=u.error||"创建角色失败"}catch(r){console.error("创建角色错误:",r),i.value="创建角色时发生错误"}finally{g.value=!1}}},R=async()=>{if(c.value){g.value=!0,i.value="";try{const r=await U.deleteCharacter(c.value.id);if(r.success){const u=C.value.findIndex(j=>j.id===c.value.id);u!==-1&&C.value.splice(u,1),c.value=null,P.value=!1}else i.value=r.error||"删除角色失败"}catch(r){console.error("删除角色错误:",r),i.value="删除角色时发生错误"}finally{g.value=!1}}},T=async()=>{if(c.value){g.value=!0;try{const r=await U.updateLastPlayTime(c.value.id);if(r.success){const u=C.value.find(j=>j.id===c.value.id);u&&(u.lastPlayTime=r.lastPlayTime),alert(`开始游戏：${c.value.name} (${c.value.job})`)}else console.error("更新游戏时间失败:",r.error)}catch(r){console.error("开始游戏错误:",r)}finally{g.value=!1}}},D=r=>{c.value&&c.value.id===r.id?c.value=null:c.value=r},F=async()=>{a.value=!0;try{await d.logout(),e.push("/")}catch(r){console.error("登出错误:",r)}finally{a.value=!1}},J=async()=>{if(!(!m.value.name||m.value.name.length<2)){g.value=!0;try{await U.checkCharacterNameExists(m.value.name)?i.value="角色名称已存在，请使用其他名称":i.value=""}catch(r){console.error("检查角色名称错误:",r)}finally{g.value=!1}}};return ee(async()=>{if(!d.isLoggedIn()){e.push("/");return}f.value=d.user,await h()}),{user:f,loading:a,formLoading:g,errorMessage:i,characters:C,availableJobs:w,selectedCharacter:c,newCharacter:m,createDialog:k,deleteDialog:P,formValid:v,nameRules:I,jobRules:L,hasSelectedCharacter:q,createCharacter:N,deleteCharacter:R,startGame:T,selectCharacter:D,getCharacterColor:z,getJobIcon:E,checkNameAvailability:J,createForm:M,logout:F}}},me={class:"text-h6"},ve={class:"d-flex align-center"},fe={class:"d-flex align-center"};function ge(d,e,f,a,i,M){const C=n("v-toolbar-title"),w=n("v-spacer"),c=n("v-icon"),m=n("v-chip"),v=n("v-btn"),I=n("v-app-bar"),L=n("v-alert"),k=n("v-card-title"),P=n("v-divider"),g=n("v-skeleton-loader"),h=n("v-card-text"),z=n("v-avatar"),E=n("v-list-item-title"),q=n("v-list-item-subtitle"),N=n("v-list-item"),R=n("v-list"),T=n("v-card-actions"),D=n("v-card"),F=n("v-col"),J=n("v-row"),r=n("v-container"),u=n("v-main"),j=n("v-text-field"),K=n("v-select"),W=n("v-form"),Q=n("v-dialog"),X=n("v-app");return b(),x(X,null,{default:t(()=>[l(I,{color:"primary",dark:""},{default:t(()=>[l(C,null,{default:t(()=>e[11]||(e[11]=[s("角色管理")])),_:1}),l(w),l(m,{class:"mr-3",color:"primary",variant:"outlined"},{default:t(()=>{var o;return[l(c,{start:""},{default:t(()=>e[12]||(e[12]=[s("mdi-account")])),_:1}),s(" "+y(((o=a.user)==null?void 0:o.username)||"玩家"),1)]}),_:1}),l(v,{icon:"",onClick:a.logout,loading:a.loading},{default:t(()=>[l(c,null,{default:t(()=>e[13]||(e[13]=[s("mdi-logout")])),_:1})]),_:1},8,["onClick","loading"])]),_:1}),l(u,{class:"home-main"},{default:t(()=>[l(r,{fluid:"",class:"mt-4 character-container"},{default:t(()=>[a.errorMessage?(b(),x(L,{key:0,type:"error",variant:"tonal",closable:"",class:"mb-4","onClick:close":e[0]||(e[0]=o=>a.errorMessage="")},{default:t(()=>[s(y(a.errorMessage),1)]),_:1})):B("",!0),l(J,null,{default:t(()=>[l(F,{cols:"12"},{default:t(()=>[l(D,{class:"mb-4"},{default:t(()=>[l(k,{class:"d-flex align-center"},{default:t(()=>[e[15]||(e[15]=V("span",null,"角色列表",-1)),l(w),l(v,{color:"primary","prepend-icon":"mdi-plus",onClick:e[1]||(e[1]=o=>a.createDialog=!0)},{default:t(()=>e[14]||(e[14]=[s(" 创建角色 ")])),_:1})]),_:1}),l(P),a.loading?(b(),x(h,{key:0},{default:t(()=>[l(g,{type:"list-item-three-line",loading:a.loading},null,8,["loading"])]),_:1})):a.characters.length===0?(b(),x(h,{key:1,class:"text-center pa-5"},{default:t(()=>[l(c,{size:"64",color:"grey-lighten-1"},{default:t(()=>e[16]||(e[16]=[s("mdi-emoticon-sad-outline")])),_:1}),e[18]||(e[18]=V("p",{class:"text-h6 mt-3"},"您还没有创建角色",-1)),l(v,{color:"primary",class:"mt-3","prepend-icon":"mdi-plus",onClick:e[2]||(e[2]=o=>a.createDialog=!0)},{default:t(()=>e[17]||(e[17]=[s(" 创建新角色 ")])),_:1})]),_:1})):(b(),G(H,{key:2},[l(R,{lines:"two"},{default:t(()=>[(b(!0),G(H,null,te(a.characters,o=>(b(),x(N,{key:o.id,active:a.selectedCharacter&&a.selectedCharacter.id===o.id,value:o.id,onClick:A=>a.selectCharacter(o),class:re(["character-item",{"selected-character":a.selectedCharacter&&a.selectedCharacter.id===o.id}]),"bg-color":a.getCharacterColor(o.job)},{prepend:t(()=>[l(z,{color:"primary",class:"mr-3"},{default:t(()=>[l(c,{icon:a.getJobIcon(o.job),color:"white"},null,8,["icon"])]),_:2},1024)]),default:t(()=>[l(E,{class:"d-flex align-center"},{default:t(()=>[V("span",me,y(o.name),1),l(m,{size:"small",color:"primary",class:"ml-3"},{default:t(()=>[s("Lv."+y(o.level),1)]),_:2},1024)]),_:2},1024),l(q,null,{default:t(()=>[V("div",ve,[l(c,{size:"small",class:"mr-1"},{default:t(()=>e[19]||(e[19]=[s("mdi-briefcase")])),_:1}),s(" 职业："+y(o.job),1)])]),_:2},1024),l(q,null,{default:t(()=>[V("div",fe,[l(c,{size:"small",class:"mr-1"},{default:t(()=>e[20]||(e[20]=[s("mdi-clock-outline")])),_:1}),s(" 最后游戏时间："+y(o.lastPlayTime),1)])]),_:2},1024)]),_:2},1032,["active","value","onClick","class","bg-color"]))),128))]),_:1}),l(P),l(T,{class:"pa-4 d-flex"},{default:t(()=>[l(w),l(v,{color:"error",variant:"outlined","prepend-icon":"mdi-delete",disabled:!a.hasSelectedCharacter||a.formLoading,loading:a.formLoading&&a.deleteDialog,onClick:e[3]||(e[3]=o=>a.deleteDialog=!0)},{default:t(()=>e[21]||(e[21]=[s(" 删除角色 ")])),_:1},8,["disabled","loading"]),l(v,{color:"primary",class:"ml-3","prepend-icon":"mdi-play",disabled:!a.hasSelectedCharacter||a.formLoading,loading:a.formLoading&&!a.deleteDialog,onClick:a.startGame},{default:t(()=>e[22]||(e[22]=[s(" 开始游戏 ")])),_:1},8,["disabled","loading","onClick"])]),_:1})],64))]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),l(Q,{modelValue:a.createDialog,"onUpdate:modelValue":e[8]||(e[8]=o=>a.createDialog=o),"max-width":"500",persistent:""},{default:t(()=>[l(D,null,{default:t(()=>[l(k,{class:"text-h5"},{default:t(()=>e[23]||(e[23]=[s("创建新角色")])),_:1}),l(h,null,{default:t(()=>[a.errorMessage?(b(),x(L,{key:0,type:"error",variant:"tonal",density:"compact",class:"mb-3"},{default:t(()=>[s(y(a.errorMessage),1)]),_:1})):B("",!0),l(W,{ref:"createForm",modelValue:a.formValid,"onUpdate:modelValue":e[6]||(e[6]=o=>a.formValid=o),onSubmit:oe(a.createCharacter,["prevent"])},{default:t(()=>[l(j,{modelValue:a.newCharacter.name,"onUpdate:modelValue":e[4]||(e[4]=o=>a.newCharacter.name=o),rules:a.nameRules,label:"角色名称",required:"",variant:"outlined",class:"mb-3",onBlur:a.checkNameAvailability,loading:a.formLoading,disabled:a.formLoading},null,8,["modelValue","rules","onBlur","loading","disabled"]),l(K,{modelValue:a.newCharacter.job,"onUpdate:modelValue":e[5]||(e[5]=o=>a.newCharacter.job=o),items:a.availableJobs,rules:a.jobRules,label:"选择职业",required:"",variant:"outlined","return-object":"","item-title":"text","item-value":"value",loading:a.formLoading,disabled:a.formLoading},{selection:t(({item:o})=>[l(c,{icon:o.raw.icon,class:"mr-2"},null,8,["icon"]),s(" "+y(o.raw.text),1)]),item:t(({item:o,props:A})=>[l(N,ne(A,{"prepend-icon":o.raw.icon}),{default:t(()=>[s(y(o.raw.text),1)]),_:2},1040,["prepend-icon"])]),_:1},8,["modelValue","items","rules","loading","disabled"])]),_:1},8,["modelValue","onSubmit"])]),_:1}),l(T,null,{default:t(()=>[l(w),l(v,{color:"grey-darken-1",variant:"text",onClick:e[7]||(e[7]=o=>a.createDialog=!1),disabled:a.formLoading},{default:t(()=>e[24]||(e[24]=[s(" 取消 ")])),_:1},8,["disabled"]),l(v,{color:"primary",variant:"text",onClick:a.createCharacter,disabled:!a.formValid||a.formLoading||a.errorMessage!=="",loading:a.formLoading},{default:t(()=>e[25]||(e[25]=[s(" 创建 ")])),_:1},8,["onClick","disabled","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(Q,{modelValue:a.deleteDialog,"onUpdate:modelValue":e[10]||(e[10]=o=>a.deleteDialog=o),"max-width":"500",persistent:""},{default:t(()=>[l(D,null,{default:t(()=>[l(k,{class:"text-h5"},{default:t(()=>e[26]||(e[26]=[s("确认删除")])),_:1}),a.selectedCharacter?(b(),x(h,{key:0},{default:t(()=>[a.errorMessage?(b(),x(L,{key:0,type:"error",variant:"tonal",density:"compact",class:"mb-3"},{default:t(()=>[s(y(a.errorMessage),1)]),_:1})):B("",!0),e[27]||(e[27]=s(" 确定要删除角色 ")),V("strong",null,y(a.selectedCharacter.name),1),e[28]||(e[28]=s(" 吗？此操作无法撤销。 "))]),_:1})):B("",!0),l(T,null,{default:t(()=>[l(w),l(v,{color:"grey-darken-1",variant:"text",onClick:e[9]||(e[9]=o=>a.deleteDialog=!1),disabled:a.formLoading},{default:t(()=>e[29]||(e[29]=[s(" 取消 ")])),_:1},8,["disabled"]),l(v,{color:"error",variant:"text",onClick:a.deleteCharacter,loading:a.formLoading,disabled:a.formLoading},{default:t(()=>e[30]||(e[30]=[s(" 删除 ")])),_:1},8,["onClick","loading","disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}const ye=Y(ue,[["render",ge],["__scopeId","data-v-35177f6d"]]);export{ye as default};
